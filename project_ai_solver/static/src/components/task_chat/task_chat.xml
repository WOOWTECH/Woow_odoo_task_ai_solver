<?xml version="1.0" encoding="utf-8"?>
<templates xml:space="preserve">

    <t t-name="project_ai_solver.TaskChat">
        <div class="o_task_chat d-flex flex-column w-100">
            <!-- Header -->
            <div class="o_task_chat_header p-2 border-bottom bg-100 fw-bold">
                Task Chat
                <span class="badge bg-primary ms-2" t-if="state.messages.length">
                    <t t-esc="state.messages.length"/>
                </span>
            </div>

            <!-- Messages area -->
            <div class="o_task_chat_messages flex-grow-1 overflow-auto p-3"
                 style="max-height: 400px;">
                <t t-if="state.loading">
                    <div class="text-center text-muted py-4">
                        <i class="fa fa-spinner fa-spin"/> Loading messages...
                    </div>
                </t>
                <t t-elif="!state.messages.length">
                    <div class="text-center text-muted py-4">
                        No messages yet. Start the conversation!
                    </div>
                </t>
                <t t-else="">
                    <t t-foreach="state.messages" t-as="msg" t-key="msg.id">
                        <div class="o_task_chat_message mb-2 p-2 rounded bg-100">
                            <div class="d-flex justify-content-between">
                                <strong class="text-primary">
                                    <t t-esc="msg.author_id[1] or 'Unknown'"/>
                                </strong>
                                <small class="text-muted">
                                    <t t-esc="msg.date"/>
                                </small>
                            </div>
                            <div class="o_task_chat_body mt-1" t-out="msg.body"/>
                            <!-- Attachments -->
                            <div t-if="msg.attachments and msg.attachments.length"
                                 class="o_task_chat_attachments mt-2 d-flex flex-wrap gap-2">
                                <t t-foreach="msg.attachments" t-as="att" t-key="att.id">
                                    <a t-if="att.is_image"
                                       t-att-href="getAttachmentUrl(att, false)"
                                       target="_blank"
                                       class="o_chat_attachment_img">
                                        <img t-att-src="getImageUrl(att)"
                                             t-att-alt="att.name"
                                             class="rounded border"
                                             style="max-width: 200px; max-height: 150px;"/>
                                    </a>
                                    <a t-else=""
                                       t-att-href="getAttachmentUrl(att, true)"
                                       target="_blank"
                                       class="badge bg-light text-dark border d-flex align-items-center gap-1 py-1 px-2 text-decoration-none">
                                        <i class="fa fa-file-o"/>
                                        <span t-esc="att.name"/>
                                        <small t-if="att.file_size" class="text-muted">
                                            (<t t-esc="formatFileSize(att.file_size)"/>)
                                        </small>
                                    </a>
                                </t>
                            </div>
                        </div>
                    </t>
                </t>
                <div t-ref="messagesEnd"/>
            </div>

            <!-- Pending attachments -->
            <div t-if="state.pendingAttachments.length"
                 class="o_task_chat_pending px-3 py-1 d-flex flex-wrap gap-2 border-top">
                <t t-foreach="state.pendingAttachments" t-as="att" t-key="att.id">
                    <div class="badge bg-light text-dark border d-flex align-items-center gap-1 py-1 px-2">
                        <i t-att-class="'fa ' + (att.is_image ? 'fa-image' : 'fa-file-o')"/>
                        <span class="text-truncate" style="max-width: 120px;" t-esc="att.name"/>
                        <button class="btn btn-sm p-0 ms-1"
                                t-on-click="() => this.removeAttachment(att_index)">
                            <i class="fa fa-times text-danger"/>
                        </button>
                    </div>
                </t>
            </div>

            <!-- Input area -->
            <div class="o_task_chat_input border-top p-2 d-flex gap-2 align-items-end">
                <input type="file" class="d-none" t-ref="fileInput"
                       multiple="multiple"
                       accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.csv,.zip"
                       t-on-change="onFileChange"/>
                <button class="btn btn-outline-secondary"
                        t-on-click="onClickAttach"
                        title="Attach file"
                        t-att-disabled="state.uploading">
                    <i t-att-class="'fa ' + (state.uploading ? 'fa-spinner fa-spin' : 'fa-paperclip')"/>
                </button>
                <textarea
                    class="form-control"
                    rows="2"
                    placeholder="Type a message..."
                    t-model="state.inputValue"
                    t-on-keydown="onKeydown"/>
                <button class="btn btn-primary"
                        t-on-click="sendMessage">
                    <i class="fa fa-paper-plane"/>
                </button>
            </div>
        </div>
    </t>

</templates>
